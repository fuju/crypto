from pwn import *
from Crypto.Util.Padding import pad, unpad
from Crypto.Cipher import AES

def reverse(string):
    reverse_string = ""
    for i in range(len(string)-1, -1, -1):
        reverse_string += string[i]
    return reverse_string


server = connect("130.192.5.212", "6541")

data=b"aaaaaa" #3 bytes so last block will be "last byte of flag+padding"
flag_reverse = ""
flag = ""
for i in range(38):
    print(f"i={i}")
    '''server.recvline() #what 
    server.recvline() #quit
    server.recvline() #enc
    server.recvline() #help'''
    server.recv(1024) #>

    server.sendline("enc".encode())
    server.recv(1024) #>
    server.sendline(data)
    ciphertext = server.recvline().decode().strip()
    print("ciphertext=" + ciphertext)

    for j in range(128):
        server.recv(1024) #what do you want to do?...
        server.sendline(b'enc')
        server.recv(1024) #>
        input = pad(int.to_bytes(j,1,'big')+flag.encode(), AES.block_size).hex()
        server.sendline(input.encode())
        output = server.recvline().decode().strip()
        #print(output)
        if output[:32] == ciphertext[96:128]:
            print(int.to_bytes(j,1,'big').decode())
            flag_reverse+=int.to_bytes(j,1,'big').decode()
            flag = reverse(flag_reverse)
            break
    data+=b'aa' #add another byte to shift

print(f"flag=CRYPTO24{flag}")