#probably hastad's broadcast aka same message encrypted with different public key
from pwn import *
from Crypto.Util.number import long_to_bytes

def iroot(k, n):
    u, s = n, n+1
    while u < s:
        s = u
        t = (k-1) * s + n // pow(s, k-1)
        u = t // k
    return s

def egcd(a, b):
    if a == 0:
        return (b, 0, 1)
    else:
        g, y, x = egcd(b % a, a)
        return (g, x - (b // a) * y, y)

e = 65537
ns = []
cs = []

#get the 65537 chipertext
for i in range(e):
    print(f"status={i}")
    server = connect("130.192.5.212",6645)
    ns.append(int(server.recvline().strip()))
    cs.append(int(server.recvline().strip()))
    server.close()

print("state: ----------------------")
print(ns)
print("cs: ----------------------")
print(cs)

us = []
vs = []

for i in range(e):
    eq = 1
    for n in ns:
        if n != ns[i]:
            eq = eq * ns[i]
    g, u, v = egcd(eq,ns[i])
    us.append(u)
    vs.append(v)


nfin = 1
c = 1
for i in range(e):
    eq = 1
    for n in ns:
        if n != ns[i]:
            eq = eq * ns[i]
    nfin = nfin * ns[i]
    c = c + (cs[i] * us[i] * eq)

cfin = c % (nfin)

print(cfin)

dec_int = iroot(e, cfin)
print("final flag found:")
print(dec_int.to_bytes(dec_int.bit_length()//8 + 1, byteorder='big').decode())